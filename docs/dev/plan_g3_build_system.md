# Plan: G.3 Build System Integration

## Overview

Create a build system integration layer that can read Mako's CMakeLists.txt and generate
Fragile build configurations. This enables building Mako executables with the Fragile compiler.

## Goals

1. Parse CMake build files to extract source files, includes, and flags
2. Create a `fragile.toml` or equivalent configuration format
3. Handle Mako's specific dependencies and conditional compilation

## Approach

### Option A: Full CMake Parser (Complex)
- Parse CMakeLists.txt syntax
- Handle variables, functions, conditionals
- Build dependency graph
- ~1000+ lines of code

### Option B: Static Build Configuration (Simple)
- Manually create build configs for key targets
- Start with simpleTransaction example
- Iterate to add more targets
- ~200-300 lines of code

### Option C: Use compile_commands.json (Pragmatic)
- CMake generates compile_commands.json
- Parse this JSON for per-file compilation info
- Extract include paths, defines, flags
- ~100-150 lines of code

**Recommendation**: Start with Option C since Mako's CMakeLists.txt already sets
`CMAKE_EXPORT_COMPILE_COMMANDS ON`. This gives us exactly what we need without
writing a CMake parser.

## Implementation Plan

### Phase 1: Parse compile_commands.json (~100 lines)
1. Create `crates/fragile-build/` crate
2. Parse compile_commands.json format
3. Extract: source file, include paths, defines, flags

### Phase 2: Build Configuration Format (~50 lines)
1. Define `FragileBuildConfig` struct
2. Support multiple targets
3. Handle library dependencies

### Phase 3: Integration with fragile-driver (~50 lines)
1. Load build config in FragileDriver
2. Pass include paths to ClangParser
3. Compile multiple files with correct flags

### Phase 4: Link Phase (~100 lines)
1. Compile C++ to object files
2. Link with rustc for final binary
3. Handle external library linking

## Dependencies

- serde_json for JSON parsing
- Mako's compile_commands.json (generated by CMake)

## Testing

1. Parse Mako's compile_commands.json
2. Build a single C++ file with extracted flags
3. Build simpleTransaction example
4. Run basic smoke test

## Risks

- compile_commands.json may not have all info (link flags, dependencies)
- May need manual specification for link phase
- External dependencies (DPDK, Boost, etc.) need special handling
